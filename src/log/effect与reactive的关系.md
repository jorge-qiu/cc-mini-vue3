# Vue 3 Effect 数据流程图

## 测试用例分析
```typescript
const user = reactive({ age: 10 })
let nextAge

effect(() => {
  nextAge = user.age + 1
})

user.age++
```

## 数据流程图

```
┌─────────────────┐
│   初始化阶段     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐    ┌─────────────────┐
│ reactive({age:10})───►│ 创建 Proxy 对象 │
│ (创建原始数据)   │    │ 拦截 get/set     │
└─────────────────┘    └─────────┬───────┘
                                  │
                                  ▼
                          ┌─────────────────┐
                          │ effect(fn) 函数  │
                          └─────────┬───────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │ 创建 ReactiveEffect │
                          │ 实例             │
                          └─────────┬───────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │ 立即执行 run()   │
                          └─────────┬───────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    依赖收集阶段                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ 访问 user.age   │────────►│ Proxy.get()     │           │
│  │ (读取操作)      │         │ 拦截器           │           │
│  └─────────────────┘         └─────────┬───────┘           │
│                                        │                   │
│                                        ▼                   │
│                              ┌─────────────────┐           │
│                              │ track(target,key)│           │
│                              │ 依赖收集函数     │           │
│                              └─────────┬───────┘           │
│                                        │                   │
│                                        ▼                   │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ targetMap       │◄────────│ 存储依赖关系     │           │
│  │ Map{            │         │ target→key→dep   │           │
│  │   target → {    │         │                 │           │
│  │     'age' → Set │         │                 │           │
│  │   }             │         │                 │           │
│  │ }               │         │                 │           │
│  └─────────────────┘         └─────────────────┘           │
│                                                             │
│  result: nextAge = 11                                      │
└─────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据更新阶段                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ user.age++      │────────►│ Proxy.set()     │           │
│  │ (修改操作)      │         │ 拦截器          │           │
│  └─────────────────┘         └─────────┬───────┘           │
│                                        │                   │
│                                        ▼                   │
│                              ┌─────────────────┐           │
│                              │ trigger(target,  │           │
│                              │ key)            │           │
│                              │ 触发依赖函数     │           │
│                              └─────────┬───────┘           │
│                                        │                   │
│                                        ▼                   │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ 查找 targetMap  │────────►│ 找到对应的 dep   │           │
│  │ 获取依赖集合     │         │ Set<effect>     │           │
│  └─────────────────┘         └─────────┬───────┘           │
│                                        │                   │
│                                        ▼                   │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ 遍历 effect     │────────►│ effect.run()    │           │
│  │ 重新执行        │         │ 重新执行 fn     │           │
│  └─────────────────┘         └─────────┬───────┘           │
│                                        │                   │
│                                        ▼                   │
│                              ┌─────────────────┐           │
│                              │ 再次访问         │           │
│                              │ user.age + 1    │           │
│                              └─────────┬───────┘           │
│                                        │                   │
│                                        ▼                   │
│  result: nextAge = 12                                        │
└─────────────────────────────────────────────────────────────┘
```

## 关键数据结构

### targetMap 结构
```
targetMap: Map<WeakMap<object, Map<string, Set<ReactiveEffect>>>>
{
  {age: 10} → {
    'age' → Set[ReactiveEffect1, ReactiveEffect2, ...]
  }
}
```

### ReactiveEffect 实例
```
ReactiveEffect {
  _fn: () => { nextAge = user.age + 1 },
  scheduler: undefined
}
```

## 执行顺序总结

1. **初始化**: `reactive({age:10})` → 创建 Proxy
2. **Effect 创建**: `effect(fn)` → 创建 ReactiveEffect → 立即执行
3. **依赖收集**: 访问 `user.age` → `track()` → 存储依赖关系
4. **数据更新**: `user.age++` → `trigger()` → 重新执行 effect
5. **自动响应**: `nextAge` 自动更新为 12

这个流程展示了 Vue 3 响应式系统的核心机制：**依赖收集 + 自动触发**。